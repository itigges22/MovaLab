# Environment Switching: Local Docker vs Cloud Supabase

**Last Updated:** December 22, 2025

---

## üéØ Overview

MovaLab supports **two deployment modes**:
1. **Local Docker** - Fully offline development using Supabase Local Stack
2. **Cloud Supabase** - Production deployment using hosted Supabase

Contributors can **easily switch between both** by changing environment variables.

---

## üîë Key Differences

| Aspect | Local Docker | Cloud Supabase |
|--------|-------------|----------------|
| **API URL** | `http://localhost:54321` | `https://[project-ref].supabase.co` |
| **Database** | `postgresql://postgres:postgres@localhost:54322/postgres` | Cloud-managed PostgreSQL |
| **Studio** | `http://localhost:54323` | `https://supabase.com/dashboard/project/[ref]` |
| **Auth Keys** | Generated by `supabase start` | From Supabase Dashboard |
| **Publishable Key** | Local-specific JWT | Cloud-specific JWT |
| **Service Role Key** | Local-specific | Cloud-specific |
| **Internet Required** | ‚ùå No | ‚úÖ Yes |
| **Cost** | Free | Free tier + usage-based |

---

## üîÑ How Switching Works

### Environment Variables Control Everything

The Next.js app uses **two environment variables** to determine which Supabase to connect to:

```env
NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**When you change these, the entire app switches environments.**

### Supabase Client Creation

All three Supabase client types (`createServerSupabase`, `createApiSupabaseClient`, `createClientSupabase`) use these environment variables:

```typescript
// lib/supabase-server.ts
import { createClient } from '@supabase/supabase-js';

export async function createServerSupabase() {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,      // Local or Cloud URL
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY! // Local or Cloud key
  );
}
```

**Result:** The app seamlessly switches between local Docker and cloud Supabase based on these two variables.

---

## üìã Setup for Each Environment

### Option 1: Local Docker (Default)

**Advantages:**
- ‚úÖ Fully offline development
- ‚úÖ Zero cloud costs
- ‚úÖ Fast iteration (no network latency)
- ‚úÖ Complete data privacy

**Setup:**

1. **Start Supabase locally:**
   ```bash
   supabase start
   ```

2. **Copy the output:**
   ```
   API URL: http://127.0.0.1:54321
   Publishable key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
   Service role key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU
   ```

3. **Update `.env.local`:**
   ```env
   # Local Docker Configuration
   NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
   NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0

   # Optional: For local development
   NEXT_PUBLIC_APP_URL=http://localhost:3000
   ```

4. **Start the app:**
   ```bash
   npm run dev
   ```

**Key Points:**
- Local keys are **fixed** and don't change
- Same keys work for all contributors using `supabase start`
- No cloud account needed

---

### Option 2: Cloud Supabase

**Advantages:**
- ‚úÖ Production-ready hosting
- ‚úÖ Automatic backups
- ‚úÖ Real-time collaboration
- ‚úÖ Managed infrastructure

**Setup:**

1. **Create Supabase project:**
   - Go to [supabase.com](https://supabase.com)
   - Create new project
   - Note your project reference (e.g., `oomnezdhkmsfjlihkmui`)

2. **Get your credentials:**
   - Dashboard ‚Üí Settings ‚Üí API
   - Copy **Project URL** and **Publishable key**

3. **Update `.env.local`:**
   ```env
   # Cloud Supabase Configuration
   NEXT_PUBLIC_SUPABASE_URL=https://oomnezdhkmsfjlihkmui.supabase.co
   NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=your-cloud-publishable-key-here

   # Optional: Production URL
   NEXT_PUBLIC_APP_URL=https://your-app.vercel.app
   ```

4. **Push migrations:**
   ```bash
   supabase link --project-ref oomnezdhkmsfjlihkmui
   supabase db push
   ```

5. **Start the app:**
   ```bash
   npm run dev
   ```

**Key Points:**
- Cloud keys are **unique** per project
- Different projects have different keys
- Requires internet connection

---

## üîÄ Switching Between Environments

### Quick Switch (Recommended)

Create **two environment files**:

**`.env.local.docker`** (Local Docker):
```env
NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
```

**`.env.local.cloud`** (Cloud Supabase):
```env
NEXT_PUBLIC_SUPABASE_URL=https://oomnezdhkmsfjlihkmui.supabase.co
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=your-cloud-key-here
```

**Switch with one command:**
```bash
# Switch to local Docker
cp .env.local.docker .env.local
npm run dev

# Switch to cloud Supabase
cp .env.local.cloud .env.local
npm run dev
```

### Manual Switch

Simply edit `.env.local` and change the two variables:

```env
# Change these two lines:
NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321  # or https://[ref].supabase.co
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=...  # matching key
```

Then restart your dev server.

---

## ‚ö†Ô∏è Important Notes

### 1. Keys MUST Match Environment

**Local Docker keys only work with Local Docker URL:**
```env
# ‚úÖ CORRECT
NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIi...

# ‚ùå WRONG (mismatched)
NEXT_PUBLIC_SUPABASE_URL=https://oomnezdhkmsfjlihkmui.supabase.co
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIi...
```

**Cloud keys only work with Cloud URL:**
```env
# ‚úÖ CORRECT
NEXT_PUBLIC_SUPABASE_URL=https://oomnezdhkmsfjlihkmui.supabase.co
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=your-cloud-publishable-key

# ‚ùå WRONG (mismatched)
NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=your-cloud-publishable-key
```

### 2. Never Use ANON_KEY (Security Risk)

**The documentation shows `NEXT_PUBLIC_SUPABASE_ANON_KEY` in examples, but MovaLab uses `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY` instead.**

**Why:**
- Anon keys bypass Row Level Security (RLS) in some configurations
- Publishable keys respect RLS policies
- RLS is MovaLab's primary security mechanism

**Always use:**
```env
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=...
```

**Never use:**
```env
NEXT_PUBLIC_SUPABASE_ANON_KEY=...  # ‚ùå Security risk
```

### 3. Local Keys are Fixed

The local Docker keys shown above are **standard Supabase demo keys** that all `supabase start` instances use:

**Publishable Key (safe to commit):**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
```

**Service Role Key (NEVER commit):**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU
```

These are **safe for local development** because they only work when connecting to `localhost:54321`.

### 4. Data is Separate

**Local Docker data and Cloud Supabase data are completely separate.**

- Local changes don't affect cloud
- Cloud changes don't affect local
- Each has its own database, users, and tables

**Syncing Data:**
If you want to sync data from cloud to local:

```bash
# Pull schema from cloud
supabase link --project-ref oomnezdhkmsfjlihkmui
supabase db pull

# Reset local database with cloud schema
supabase db reset
```

---

## üìö Additional Resources

### Official Supabase Documentation

- **Local Development:** https://supabase.com/docs/guides/cli/local-development
- **CLI Commands:** https://supabase.com/docs/guides/cli
- **Environment Variables:** https://supabase.com/docs/guides/getting-started/quickstarts/nextjs

### MovaLab Documentation

- **Docker Setup Guide:** `/docs/docker-setup.md`
- **First-Time Setup Script:** `/scripts/first-time-setup.sh`
- **Migration README:** `/supabase/migrations/README.md`

---

## ‚úÖ Verification

### Test Local Docker Connection

```bash
# Start local Supabase
supabase start

# Check status
supabase status

# Expected output:
# API URL: http://127.0.0.1:54321
# DB URL: postgresql://postgres:postgres@127.0.0.1:54322/postgres
# Studio URL: http://127.0.0.1:54323
# Publishable key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Test Cloud Connection

```bash
# Link to cloud project
supabase link --project-ref oomnezdhkmsfjlihkmui

# Test connection
supabase db pull

# Expected: Successful schema download
```

### Test App Connection

```bash
# Start app
npm run dev

# Open browser to http://localhost:3000
# Try logging in with test user
# Check browser console for connection errors
```

If you see authentication working, the connection is successful!

---

## üéØ Summary

**Local Docker:**
- URL: `http://localhost:54321`
- Key: Fixed demo key (same for all contributors)
- Use case: Development, testing, offline work

**Cloud Supabase:**
- URL: `https://[your-project-ref].supabase.co`
- Key: Unique per project
- Use case: Production, collaboration, hosting

**Switching:** Change `.env.local` variables and restart dev server.

**Security:** Always use `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY`, never `ANON_KEY`.
